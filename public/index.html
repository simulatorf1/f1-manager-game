<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Manager E-Strategy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <!-- CARGA DE SUPABASE CON GARANT√çA -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    
    <!-- INICIALIZACI√ìN INMEDIATA -->
    <script>
        console.log('üîß Inicializando Supabase...');
    
        setTimeout(function() {
            if (typeof supabase === 'undefined') {
                console.error('‚ùå Supabase CDN no carg√≥');
                alert('Error cr√≠tico: Recarga la p√°gina (F5)');
                return;
            }
            
            try {
                window.supabase = supabase.createClient(
                    'https://xbnbbmhcveyzrvvmdktg.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhibmJibWhjdmV5enJ2dm1ka3RnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NzY1NDgsImV4cCI6MjA4MTU1MjU0OH0.RaNk5B62P97WB93kKJMR1OLac68lDb9JTVthu8_m3Hg'
                );
                console.log('‚úÖ Supabase inicializado');
            
                // Cargar scripts en orden
                cargarScripts();
            
            } catch (error) {
                console.error('‚ùå Error creando cliente:', error);
            }
        }, 2000);
    
        function cargarScripts() {
            const scripts = [
                'js/config.js',
                'js/auth.js',      
                'js/main.js',       
                'js/fabricacion.js', 
                'js/tabs.js',
                'js/almacen.js',
                'js/integracion.js',
                'js/init-db.js'
            ];
        
            // Cargar secuencialmente
            cargarScriptSecuencial(scripts, 0);
        }
    
        function cargarScriptSecuencial(scripts, index) {
            if (index >= scripts.length) {
                console.log('‚úÖ Todos los scripts cargados');
                iniciarAplicacion();
                return;
            }
        
            const script = document.createElement('script');
            script.src = scripts[index];
            script.onload = () => {
                console.log('üì• Cargado:', scripts[index]);
                cargarScriptSecuencial(scripts, index + 1);
            };
            script.onerror = () => {
                console.error('‚ùå Error cargando:', scripts[index]);
                cargarScriptSecuencial(scripts, index + 1);
            };
        
            document.body.appendChild(script);
        }
        
        // Funci√≥n principal de inicio
        async function iniciarAplicacion() {
            console.log('üöÄ Iniciando aplicaci√≥n F1 Manager...');
            
            // Verificar que Supabase est√° cargado
            if (!window.supabase) {
                console.error('‚ùå Supabase no est√° disponible');
                mostrarErrorCritico('No se pudo conectar con la base de datos');
                return;
            }
            
            console.log('‚úÖ Supabase listo para usar');
            
            // Verificar sesi√≥n
            const { data: { session } } = await window.supabase.auth.getSession();
            
            if (session) {
                console.log('‚úÖ Usuario autenticado:', session.user.email);
                
                // Esperar a que main.js se cargue
                const checkF1Manager = setInterval(() => {
                    if (window.F1Manager) {
                        clearInterval(checkF1Manager);
                        window.f1Manager = new F1Manager(session.user);
                        window.f1Manager.init();
                    }
                }, 100);
                
            } else {
                console.log('üë§ No hay sesi√≥n, mostrar login');
                // auth.js se encargar√° del login
            }
        }
        
        function mostrarErrorCritico(mensaje) {
            document.body.innerHTML = `
                <div style="
                    min-height: 100vh;
                    background: #15151e;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    color: white;
                    text-align: center;
                    padding: 20px;
                ">
                    <div>
                        <h1 style="color: #e10600; margin-bottom: 20px;">‚ùå ERROR CR√çTICO</h1>
                        <p>${mensaje}</p>
                        <button onclick="location.reload()" style="
                            margin-top: 20px;
                            padding: 10px 20px;
                            background: #e10600;
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                        ">
                            Reintentar
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Script de arranque r√°pido (OPCIONAL - descomentar para auto-login)
        /*
        async function quickStart() {
            console.log('üöÄ Inicio r√°pido del juego');
            
            // Verificar que Supabase est√° listo
            if (!window.supabase || !window.supabase.auth) {
                console.error('‚ùå Supabase no est√° disponible');
                return;
            }
            
            // Verificar si ya hay sesi√≥n
            const { data: { session } } = await window.supabase.auth.getSession();
            if (session) {
                console.log('‚úÖ Ya hay sesi√≥n activa');
                return;
            }
            
            try {
                // 1. Intentar iniciar sesi√≥n con demo
                const { data: signInData, error: signInError } = await window.supabase.auth.signInWithPassword({
                    email: 'demo@f1manager.com',
                    password: 'demo123'
                });
                
                if (!signInError) {
                    console.log('‚úÖ Sesi√≥n demo iniciada');
                    location.reload();
                    return;
                }
                
                // 2. Si no existe, crear usuario demo
                console.log('üìù Creando usuario demo...');
                const { data: user, error: signUpError } = await window.supabase.auth.signUp({
                    email: 'demo@f1manager.com',
                    password: 'demo123',
                    options: {
                        data: { username: 'Demo Manager' },
                        emailRedirectTo: window.location.origin
                    }
                });
                
                if (signUpError) {
                    console.error('‚ùå Error creando demo:', signUpError.message);
                    return;
                }
                
                console.log('‚úÖ Usuario demo creado:', user);
                alert('Usuario demo creado. Usa: demo@f1manager.com / demo123');
                
            } catch (error) {
                console.error('‚ùå Error en quickStart:', error);
            }
        }
        
        // Ejecutar despu√©s de que todo est√© cargado
        window.addEventListener('DOMContentLoaded', () => {
            // Esperar a que Supabase est√© listo
            const checkSupabase = setInterval(() => {
                if (window.supabase && window.supabase.auth) {
                    clearInterval(checkSupabase);
                    // Descomentar para auto-login con demo
                    // quickStart();
                }
            }, 500);
        });
        */
        
        // Debug helper
        window.debugF1 = {
            resetDemo: async () => {
                localStorage.clear();
                await window.supabase?.auth?.signOut();
                location.reload();
            },
            checkTables: async () => {
                console.log('üìä Verificando tablas...');
                const tables = ['escuderias', 'piezas_almacen', 'fabricacion_actual', 'coches_stats'];
                for (let table of tables) {
                    try {
                        const { data, error } = await window.supabase
                            .from(table)
                            .select('count', { count: 'exact', head: true });
                        if (error) {
                            console.log(`${table}: ‚ùå Error - ${error.message}`);
                        } else {
                            console.log(`${table}: ‚úÖ ${data} registros`);
                        }
                    } catch (e) {
                        console.log(`${table}: ‚ùå No existe`);
                    }
                }
            },
            createDemo: async () => {
                if (!window.supabase || !window.supabase.auth) {
                    console.error('‚ùå Supabase no disponible');
                    return;
                }
                
                try {
                    // Intentar iniciar sesi√≥n
                    const { error: signInError } = await window.supabase.auth.signInWithPassword({
                        email: 'demo@f1manager.com',
                        password: 'demo123'
                    });
                    
                    if (!signInError) {
                        console.log('‚úÖ Sesi√≥n iniciada');
                        location.reload();
                        return;
                    }
                    
                    // Crear usuario
                    const { error: signUpError } = await window.supabase.auth.signUp({
                        email: 'demo@f1manager.com',
                        password: 'demo123',
                        options: {
                            data: { username: 'Demo Manager' }
                        }
                    });
                    
                    if (signUpError) {
                        console.error('‚ùå Error:', signUpError.message);
                    } else {
                        console.log('‚úÖ Usuario creado. Usa: demo@f1manager.com / demo123');
                    }
                } catch (error) {
                    console.error('‚ùå Error:', error);
                }
            }
        };
    </script>
</body>
</html>
