name: Build Android APK
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Capacitor
        run: |
          npm install @capacitor/core @capacitor/cli @capacitor/android
          mkdir -p out
          touch out/index.html
          npx cap add android || true

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Install ImageMagick for icon processing
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Download and setup icon
        run: |
          echo "Descargando icono personalizado..."
          wget -q https://raw.githubusercontent.com/simulatorf1/f1-manager-game/main/public/IMG_20260202_194732.PNG -O icon.png
          
          if [ -f "icon.png" ]; then
            echo "‚úÖ Icono descargado correctamente"
          else
            echo "‚ö†Ô∏è  No se pudo descargar el icono, creando uno temporal"
            convert -size 512x512 xc:#2196F3 icon.png
          fi

      - name: Prepare Android project
        run: |
          # Crear estructura b√°sica si no existe
          mkdir -p android/app/src/main/res
          mkdir -p android/app/src/main/java/com/miweb/app
          
          # Crear iconos para Android
          if [ -f "icon.png" ]; then
            echo "Creando iconos Android..."
            mkdir -p android/app/src/main/res/mipmap-mdpi
            mkdir -p android/app/src/main/res/mipmap-hdpi
            mkdir -p android/app/src/main/res/mipmap-xhdpi
            mkdir -p android/app/src/main/res/mipmap-xxhdpi
            mkdir -p android/app/src/main/res/mipmap-xxxhdpi
            
            convert icon.png -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png
            convert icon.png -resize 72x72 android/app/src/main/res/mipmap-hdpi/ic_launcher.png
            convert icon.png -resize 96x96 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
            convert icon.png -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
            convert icon.png -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
            
            echo "‚úÖ Iconos creados en diferentes resoluciones"
          fi

      - name: Sync Capacitor
        run: |
          npx cap sync android || echo "Sync completado"

      - name: Fix build issues
        run: |
          # Asegurarse de que los directorios existen
          mkdir -p android/app/src/main/assets
          mkdir -p android/app/src/main/res/values
          
          # Crear strings.xml con el nombre de la app
          echo '<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="app_name">Critical LAP</string>
</resources>' > android/app/src/main/res/values/strings.xml
          
          # A√±adir configuraciones de Gradle si no existen
          if [ ! -f "android/app/build.gradle" ]; then
            echo "Creando build.gradle b√°sico..."
            echo 'apply plugin: "com.android.application"

android {
    namespace "com.miweb.app"
    compileSdkVersion rootProject.ext.compileSdkVersion ?: 34
    defaultConfig {
        applicationId "com.miweb.app"
        minSdkVersion rootProject.ext.minSdkVersion ?: 22
        targetSdkVersion rootProject.ext.targetSdkVersion ?: 34
        versionCode 1
        versionName "1.0"
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
        }
    }
}

dependencies {
    implementation fileTree(dir: "libs", include: ["*.jar"])
    implementation project(":capacitor-android")
}' > android/app/build.gradle
          fi
          
          # A√±adir configuraci√≥n para evitar problemas de Kotlin
          echo "
configurations.all {
    resolutionStrategy.eachDependency { DependencyResolveDetails details ->
        if (details.requested.group == 'org.jetbrains.kotlin') {
            details.useVersion '1.8.22'
        }
    }
}" >> android/app/build.gradle

      - name: Build APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug --no-daemon --stacktrace --info

      - name: Check APK file
        run: |
          echo "Buscando archivos APK..."
          find android -name "*.apk" -type f | head -20
          echo ""
          echo "Contenido de outputs/apk/debug:"
          ls -la android/app/build/outputs/apk/ || echo "Directorio no existe"
          ls -la android/app/build/outputs/apk/debug/ 2>/dev/null || echo "Directorio debug no existe"

      - name: Rename and compress APK
        run: |
          # Buscar el APK generado
          APK_FILE=$(find android -name "*debug*.apk" -type f | head -1)
          
          if [ -f "$APK_FILE" ]; then
            echo "‚úÖ APK encontrado: $APK_FILE"
            # Copiar al directorio esperado
            mkdir -p android/app/build/outputs/apk/debug/
            cp "$APK_FILE" android/app/build/outputs/apk/debug/ManagerMotorsport.apk
            
            # Comprimir
            cd android/app/build/outputs/apk/debug/
            gzip -c ManagerMotorsport.apk > ManagerMotorsport.apk.gz
            echo "APK renombrado: ManagerMotorsport.apk"
            echo "Tama√±o original: $(du -h ManagerMotorsport.apk | cut -f1)"
            echo "Tama√±o comprimido: $(du -h ManagerMotorsport.apk.gz | cut -f1)"
          else
            echo "‚ùå ERROR: No se encontr√≥ ning√∫n archivo APK"
            exit 1
          fi

      - name: Upload APK (Compressed)
        uses: actions/upload-artifact@v4
        with:
          name: ManagerMotorsport-APK
          path: android/app/build/outputs/apk/debug/ManagerMotorsport.apk.gz
          retention-days: 7
          if-no-files-found: error
          overwrite: true
          compression-level: 0

      - name: Display APK info
        run: |
          echo "‚úÖ Build completado"
          echo "üì± Nombre de la app: Critical LAP"
          echo "üéØ Icono: IMG_20260202_194732.PNG"
          echo "üì• Para descargar: Ve a 'Artifacts' ‚Üí 'ManagerMotorsport-APK'"
          echo "‚ÑπÔ∏è  Descomprime el archivo .gz antes de instalar"
