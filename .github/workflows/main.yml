name: Build Android APK
on: [workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Generate Android Icons from Single Image
        run: |
          sudo apt-get update && sudo apt-get install -y imagemagick
          
          # Verificar si hay un icono personalizado
          if [ -f "icon.png" ]; then
            ICON_SOURCE="icon.png"
            echo "‚úÖ Usando icon.png personalizado"
          elif [ -f "icono.png" ]; then
            ICON_SOURCE="icono.png"
            echo "‚úÖ Usando icono.png personalizado"
          elif [ -f "motosport-icon.png" ]; then
            ICON_SOURCE="motosport-icon.png"
            echo "‚úÖ Usando motosport-icon.png personalizado"
          else
            echo "‚ö†Ô∏è  No se encontr√≥ icono personalizado. Usando icono por defecto..."
            wget -O default-icon.png "https://cdn-icons-png.flaticon.com/512/1998/1998672.png"
            ICON_SOURCE="default-icon.png"
          fi
          
          echo "üîÑ Preparando icono: $ICON_SOURCE"
          # Solo guardamos el icono para usarlo despu√©s
          cp "$ICON_SOURCE" /tmp/app-icon-source.png
          echo "‚úÖ Icono preparado para usar despu√©s"
      
      - name: Install Capacitor
        run: |
          npm install @capacitor/core @capacitor/cli @capacitor/android
          mkdir -p out
          touch out/index.html
          npx cap add android || true
      
      - name: Apply Custom Icon and Name
        run: |
          # Crear directorios de iconos
          mkdir -p android/app/src/main/res/mipmap-hdpi
          mkdir -p android/app/src/main/res/mipmap-mdpi
          mkdir -p android/app/src/main/res/mipmap-xhdpi
          mkdir -p android/app/src/main/res/mipmap-xxhdpi
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi
          
          # Aplicar el icono si tenemos uno preparado
          if [ -f "/tmp/app-icon-source.png" ]; then
            echo "üîÑ Generando iconos en todos los tama√±os..."
            convert "/tmp/app-icon-source.png" -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png
            convert "/tmp/app-icon-source.png" -resize 72x72 android/app/src/main/res/mipmap-hdpi/ic_launcher.png
            convert "/tmp/app-icon-source.png" -resize 96x96 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
            convert "/tmp/app-icon-source.png" -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
            convert "/tmp/app-icon-source.png" -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
            echo "‚úÖ Iconos personalizados aplicados"
          else
            echo "‚ÑπÔ∏è  Usando iconos por defecto de Capacitor"
          fi
          
          # Configurar nombre de la app
          mkdir -p android/app/src/main/res/values
          echo '<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="app_name">Motosport Manager</string>
    <string name="title_activity_main">Motosport Manager</string>
</resources>' > android/app/src/main/res/values/strings.xml
          
          # Tambi√©n actualizar capacitor.config.json si existe
          if [ -f capacitor.config.json ]; then
            echo "üìù Actualizando capacitor.config.json..."
            npm install -g jq || true
            if command -v jq &> /dev/null; then
              jq '.appName = "Motosport Manager"' capacitor.config.json > tmp.json && mv tmp.json capacitor.config.json
            fi
          fi
          
          echo "‚úÖ Nombre configurado: Motosport Manager"
      
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'
      
      - name: Sync Capacitor
        run: npx cap sync android
      
      - name: Force Fix Kotlin Duplicates
        run: |
          echo "configurations.all {
              resolutionStrategy.eachDependency { DependencyResolveDetails details ->
                  if (details.requested.group == 'org.jetbrains.kotlin') {
                      details.useVersion '1.8.22'
                  }
              }
          }" >> android/app/build.gradle
          
          echo "android.useAndroidX=true" >> android/gradle.properties
          echo "android.enableJetifier=true" >> android/gradle.properties
      
      - name: Build APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug --no-daemon --stacktrace
      
      - name: Compress APK before upload
        run: |
          cd android/app/build/outputs/apk/debug
          gzip -c app-debug.apk > app-debug.apk.gz
          echo "Original APK size: $(du -h app-debug.apk | cut -f1)"
          echo "Compressed APK size: $(du -h app-debug.apk.gz | cut -f1)"
      
      - name: Upload APK (Compressed)
        uses: actions/upload-artifact@v4
        with:
          name: Motosport-Manager-APK
          path: android/app/build/outputs/apk/debug/app-debug.apk.gz
          retention-days: 7
          if-no-files-found: error
          overwrite: true
          compression-level: 0
      
      - name: Upload APK (Original) como fallback
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: Motosport-Manager-APK-Raw
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 1
          if-no-files-found: error
      
      - name: Display APK info
        run: |
          cd android/app/build/outputs/apk/debug
          echo "APK generado: $(pwd)/app-debug.apk"
          echo "Tama√±o: $(du -h app-debug.apk | cut -f1)"
          echo "Nombre de la app: Motosport Manager"
          echo "Para descargar: ve a la pesta√±a 'Artifacts' en esta ejecuci√≥n de Actions"
