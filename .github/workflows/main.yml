name: Build Android APK
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Capacitor and dependencies
        run: |
          npm install @capacitor/core @capacitor/cli @capacitor/android
          mkdir -p out
          touch out/index.html
          npx cap add android || true

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Configure Android app
        run: |
          # Crear el script de configuraciÃ³n
          cat > setup-android.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const { execSync } = require('child_process');
          
          console.log('ðŸ”§ Configurando Android...');
          
          // Crear strings.xml
          const stringsXml = `<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="app_name">Critical LAP</string>
</resources>`;
          
          fs.mkdirSync('android/app/src/main/res/values', { recursive: true });
          fs.writeFileSync('android/app/src/main/res/values/strings.xml', stringsXml);
          
          // Actualizar AndroidManifest.xml
          if (fs.existsSync('android/app/src/main/AndroidManifest.xml')) {
              let manifest = fs.readFileSync('android/app/src/main/AndroidManifest.xml', 'utf8');
              manifest = manifest.replace(/android:label="[^"]*"/g, 'android:label="@string/app_name"');
              fs.writeFileSync('android/app/src/main/AndroidManifest.xml', manifest);
          }
          
          // Descargar y configurar icono
          try {
              execSync('curl -s -o /tmp/icon.png https://raw.githubusercontent.com/simulatorf1/f1-manager-game/main/public/IMG_20260202_194732.PNG');
              
              if (fs.existsSync('/tmp/icon.png')) {
                  const sizes = [
                      ['mipmap-mdpi', 48],
                      ['mipmap-hdpi', 72],
                      ['mipmap-xhdpi', 96],
                      ['mipmap-xxhdpi', 144],
                      ['mipmap-xxxhdpi', 192]
                  ];
                  
                  for (const [folder, size] of sizes) {
                      const dir = `android/app/src/main/res/${folder}`;
                      fs.mkdirSync(dir, { recursive: true });
                      execSync(`convert /tmp/icon.png -resize ${size}x${size} ${dir}/ic_launcher.png 2>/dev/null || echo "FallÃ³ ${folder}"`);
                  }
                  console.log('âœ… Icono configurado');
              }
          } catch (e) {
              console.log('âš ï¸  Error con icono:', e.message);
          }
          
          console.log('ðŸŽ‰ ConfiguraciÃ³n completada!');
          EOF
          
          # Ejecutar el script
          node setup-android.js

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Fix Kotlin
        run: |
          echo "configurations.all {
              resolutionStrategy.eachDependency { details ->
                  if (details.requested.group == 'org.jetbrains.kotlin') {
                      details.useVersion '1.8.22'
                  }
              }
          }" >> android/app/build.gradle
          
          echo "android.useAndroidX=true" >> android/gradle.properties
          echo "android.enableJetifier=true" >> android/gradle.properties

      - name: Build APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug --no-daemon --stacktrace

      - name: Prepare APK
        run: |
          cd android/app/build/outputs/apk/debug
          mv app-debug.apk CriticalLAP.apk
          gzip -k CriticalLAP.apk
          echo "âœ… APK: CriticalLAP.apk"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: CriticalLAP-APK
          path: android/app/build/outputs/apk/debug/CriticalLAP.apk.gz

      - name: Done
        run: echo "ðŸŽ‰ Â¡APK Critical LAP con icono personalizado lista!"
